# ESP32 CAN 测试系统

![版本](https://img.shields.io/badge/版本-1.0.0-blue)
![平台](https://img.shields.io/badge/平台-ESP32-green)
![许可证](https://img.shields.io/badge/许可证-MIT-orange)

## 项目概述

这是一个基于ESP32的CAN总线通信测试系统，用于实现多设备之间的协同工作。系统能够控制LED灯光效果、电机、雾化器，并检测木鱼敲击等事件，通过CAN总线实现设备间的实时通信。

该项目适用于以下场景：
- 交互式艺术装置
- 物联网设备控制系统
- 工业自动化控制原型
- 教育和研究环境中的分布式系统演示

### 系统架构

```
┌────────────────┐                     ┌────────────────┐
│                │                     │                │
│ TouchDesigner  │                     │ WS2812 LED灯带 │
│   模拟器       │◄────┐          ┌───►│                │
│  (PC软件)      │     │          │    └────────────────┘
└───────┬────────┘     │          │    
        │              │          │    
        │ UART         │          │    
        ▼              │          ▼    
┌────────────────┐     │    ┌────────────────┐
│                │     │    │                │
│  ESP32 发送端  │     │    │  ESP32 接收端  │
│                │◄────┼────►│                │
└───────┬────────┘     │    └────────────────┘
        │              │          
        │ CAN总线      │          
        ├──────────────┼─────────┬──────────┐
        │              │         │          │
        ▼              │         ▼          ▼
┌────────────────┐     │    ┌────────────┐  ┌────────────┐
│                │     │    │            │  │            │
│  ESP32 电机    │     │    │  ESP32     │  │  更多      │
│  控制器        │◄────┘    │  雾化器    │  │  设备...   │
│                │          │            │  │            │
└────────────────┘          └────────────┘  └────────────┘
```

系统使用CAN总线作为设备间的主要通信方式，通过TouchDesigner模拟器发送命令到ESP32主控制器，再由主控制器转发命令到各个功能模块。系统还支持从木鱼传感器检测敲击事件并通知整个系统。

## 项目组件

### 1. espcan-test-send (发送端)

发送端ESP32设备是整个系统的核心控制器，负责接收上位机命令并转发到CAN总线。

**主要功能：**
- 通过UART接收TouchDesigner的控制命令（波特率115200）
- 将命令转发到CAN总线（波特率500Kbps）
- 支持LED、情绪效果、随机效果、电机和雾化器控制命令解析
- 检测木鱼敲击并发送事件通知
- 实现各种命令格式的解析和转换

**硬件连接：**
- CAN_TX: GPIO 5
- CAN_RX: GPIO 4
- 木鱼传感器1: GPIO 18（振动传感器）
- 木鱼传感器2: GPIO 19（敲击传感器）
- UART: 默认USB连接（GPIO 1/3）

### 2. espcan-test-receiver (接收端)

接收端ESP32设备负责接收CAN总线命令并控制LED灯带。

**主要功能：**
- 接收CAN总线上的各类控制命令
- 控制WS2812 LED灯带实现各种视觉效果
- 实现三种情绪效果：
  - 彩虹效果（开心）：多彩渐变滚动
  - 蓝色闪电（伤心）：蓝色闪烁效果
  - 紫色追逐（惊讶）：紫色光点追逐效果
- 支持随机效果：
  - 流星雨效果：随机颜色流星划过
  - 颜色爆炸效果：从中心向两侧扩散的颜色

**硬件连接：**
- CAN_TX: GPIO 5
- CAN_RX: GPIO 4
- LED数据线: GPIO 2（可配置）
- LED数量: 60（可配置）

### 3. espcan-motor-pio (电机控制)

电机控制ESP32设备负责接收命令并控制电机。

**主要功能：**
- 接收CAN命令（ID: 0x301）控制PWM输出
- 通过SSR(固态继电器)控制电机启停
- 支持调节电机速度（0-255 PWM占空比）
- 向CAN总线发送状态确认消息

**硬件连接：**
- CAN_TX: GPIO 5
- CAN_RX: GPIO 4
- PWM输出: GPIO 17
- 电机使能: GPIO 16

### 4. espcan-fogger (雾化器控制)

雾化器控制ESP32设备负责接收命令并控制雾化器。

**主要功能：**
- 接收CAN命令（ID: 0x321）控制继电器开关
- 控制雾化器启停
- 向CAN总线发送状态确认消息

**硬件连接：**
- CAN_TX: GPIO 5
- CAN_RX: GPIO 4
- 继电器控制: GPIO 15

### 5. td-tester (TouchDesigner模拟器)

Python编写的上位机程序，模拟TouchDesigner的控制功能。

**主要功能：**
- 提供图形用户界面控制各设备
- 通过串口发送控制命令
- 接收并显示设备状态和木鱼敲击事件
- 支持以下控制功能:
  - LED开关控制
  - 情绪效果选择（开心/伤心/惊讶）
  - 随机效果控制（速度和亮度调节）
  - 电机控制（启停和速度调节）
  - 雾化器控制（开关）
  - 自定义命令发送

**系统要求：**
- Python 3.6+
- pySerial库
- tkinter库（GUI支持）

## 通信协议详解

系统使用CAN总线进行设备间通信，采用标准帧格式，波特率500Kbps。

### 消息ID及数据格式

| 消息ID | 功能 | 数据格式 | 示例 |
|--------|------|---------|------|
| 0x456 | LED控制 | 1字节: [0=关/1=开] | `0x01` (开启LED) |
| 0x789 | 情绪状态 | 1字节: [1=开心/2=伤心/3=惊讶/4=随机] | `0x01` (开心模式) |
| 0xABC | 随机效果 | 3字节: [状态(0/1), 速度(0-255), 亮度(0-255)] | `0x01 0x80 0xC8` (开启，速度128，亮度200) |
| 0x301 | 电机控制 | 2字节: [PWM(0-255), 状态(0/1)] | `0x80 0x01` (PWM值128，启动) |
| 0x321 | 雾化器控制 | 1字节: [0=关/1=开] | `0x01` (开启雾化器) |
| 0x123 | 木鱼敲击事件 | 1字节: [1=敲击] | `0x01` (检测到敲击) |

### UART命令格式

TouchDesigner模拟器通过UART发送以下格式的命令到ESP32发送端：

| 命令格式 | 说明 | 示例 |
|---------|------|------|
| `EMOTION:n` | 设置情绪状态 | `EMOTION:1` (开心) |
| `LED:n` | 控制LED | `LED:1` (开启) |
| `RANDOM:state:speed:brightness` | 控制随机效果 | `RANDOM:1:128:200` (开启，中速，高亮) |
| `MOTOR:pwm:state` | 控制电机 | `MOTOR:128:1` (50%占空比，启动) |
| `FOGGER:n` | 控制雾化器 | `FOGGER:1` (开启) |
| `WOODFISH_TEST` | 测试木鱼敲击 | `WOODFISH_TEST` |

## 构建与使用

### 软件要求

- PlatformIO (用于编译和上传ESP32固件)
- Python 3.6+ (用于运行TouchDesigner模拟器)
- ESP-IDF 4.0+ (ESP32开发框架)
- Git (版本控制)

### 硬件要求

- ESP32开发板 (每个功能模块至少一块)
- CAN收发器模块 (如TJA1050或SN65HVD230)
- WS2812 LED灯带 (60灯珠推荐)
- 电机及驱动电路 (任何可通过PWM控制的电机)
- 继电器模块 (用于控制雾化器)
- 木鱼敲击传感器 (振动传感器和压电传感器)
- 120Ω终端电阻 (CAN总线两端)
- 5V电源 (用于ESP32和LED灯带)
- 连接线缆

### 安装步骤

#### 1. 克隆仓库

```bash
git clone https://github.com/peterpanstechland/espcan-test.git
cd espcan-test
```

#### 2. 编译并上传ESP32固件

对每个ESP32设备，分别进入对应目录并编译上传：

```bash
# 发送端
cd espcan-test-send
pio run -t upload

# 接收端
cd ../espcan-test-receiver
pio run -t upload

# 电机控制
cd ../espcan-motor-pio
pio run -t upload

# 雾化器控制
cd ../espcan-fogger
pio run -t upload
```

#### 3. 安装Python依赖并运行模拟器

```bash
cd ../td-tester
pip install -r requirements.txt
python td_simulator.py
```

### 使用指南

1. **硬件连接**:
   - 将所有ESP32设备连接到同一个CAN总线
   - 确保CAN总线两端都有120Ω终端电阻
   - 将LED灯带连接到接收端ESP32
   - 将电机和雾化器连接到各自的控制设备
   - 将木鱼传感器连接到发送端ESP32

2. **启动系统**:
   - 给所有设备供电
   - 将发送端ESP32通过USB连接到计算机
   - 启动TouchDesigner模拟器
   - 在模拟器中选择正确的串口并连接

3. **控制系统**:
   - 使用模拟器界面上的各种控制按钮和滑块来控制系统
   - 观察LED灯带的变化和其他设备的响应
   - 敲击木鱼，观察模拟器中的状态变化

## 常见问题解答

**Q: 设备之间无法通信怎么办？**

A: 检查CAN总线连接是否正确，确保总线两端有终端电阻，检查波特率设置是否一致（500Kbps）。

**Q: LED灯带不亮或显示错误颜色？**

A: 检查LED灯带连接，确认电源是否足够（5V/2A以上推荐），检查接收端代码中的LED灯数量配置是否与实际一致。

**Q: 木鱼敲击检测不灵敏或误触发？**

A: 调整代码中的`WOODEN_FISH_DEBOUNCE_MS`参数（默认50ms），增大可减少误触发，减小可提高灵敏度。

**Q: 模拟器无法连接到ESP32？**

A: 检查COM口选择是否正确，确认波特率设置（115200），检查USB线缆是否完好。

## 贡献指南

欢迎对本项目做出贡献！您可以通过以下方式参与：

1. 提交Bug报告或功能请求
2. 提交代码改进或新功能
3. 改进文档或翻译

请遵循以下步骤：

1. Fork本仓库
2. 创建您的特性分支 (`git checkout -b feature/amazing-feature`)
3. 提交您的更改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建一个Pull Request

## 未来计划

- 添加Web界面控制
- 支持OTA固件更新
- 增加更多灯光效果和交互模式
- 集成MQTT支持，实现远程控制
- 开发真正的TouchDesigner集成模块

## 许可证

本项目采用MIT许可证 - 详情请参阅 [LICENSE](LICENSE) 文件。

## 联系方式

项目维护者: Peter Pan Tech Land
GitHub: [https://github.com/peterpanstechland](https://github.com/peterpanstechland)

## 致谢

- ESP-IDF 团队提供的优秀开发框架
- LED灯带库的贡献者
- 所有测试和提供反馈的用户 