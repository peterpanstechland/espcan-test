# 木鱼互动装置 - 基于ESP32的分布式CAN总线控制系统

这个项目是一个基于ESP32的分布式控制系统，使用CAN总线进行通信，实现了一套完整的木鱼互动装置。该装置通过木鱼敲击触发不同的声光电效果，展示不同的情绪状态反馈。

## 📌 GPIO引脚对照表

| 模块 | 功能 | GPIO引脚 | 说明 |
|------|------|---------|------|
| **espcan-master-muyu** | CAN-TX | GPIO5 | CAN总线发送引脚 |
|  | CAN-RX | GPIO4 | CAN总线接收引脚 |
|  | 振动传感器 | GPIO22 | 检测木鱼敲击振动 |
|  | 声音传感器 | GPIO23 | 检测木鱼敲击声音 |
| **espcan-light** | CAN-TX | GPIO5 | CAN总线发送引脚 |
|  | CAN-RX | GPIO4 | CAN总线接收引脚 |
|  | LED状态指示灯 | GPIO2 | 板载LED |
|  | WS2812灯带 | GPIO18 | 200个LED灯珠 |
| **espcan-sound** | CAN-TX | GPIO5 | CAN总线发送引脚 |
|  | CAN-RX | GPIO4 | CAN总线接收引脚 |
|  | 打雷音效 | GPIO23 | 惊讶情绪对应音效 |
|  | 小雨点音效 | GPIO22 | 伤心情绪对应音效 |
|  | 木鱼敲击音效 | GPIO19 | 木鱼敲击对应音效 |
|  | 开心音效 | GPIO18 | 开心情绪对应音效 |
|  | 随机音效 | GPIO17 | 随机情绪对应音效 |
| **espcan-motor** | CAN-TX | GPIO5 | CAN总线发送引脚 |
|  | CAN-RX | GPIO4 | CAN总线接收引脚 |
|  | PWM输出 | GPIO19 | 控制电机速度 |
|  | 固态继电器 | GPIO23 | 控制电机启停 |
| **espcan-fogger** | CAN-TX | GPIO5 | CAN总线发送引脚 |
|  | CAN-RX | GPIO4 | CAN总线接收引脚 |
|  | 继电器控制 | GPIO26 | 控制雾化器启停 |

## 系统架构

系统由以下几个模块组成，每个模块都是一个独立的ESP32开发板：

1. **espcan-master-muyu**: 木鱼主控模块
   - 功能：检测木鱼敲击事件并发送控制命令到其他模块
   - 传感器：振动传感器(GPIO22)和声音传感器(GPIO23)
   - 通信：CAN总线发送各类控制指令，UART接收TouchDesigner控制命令

2. **espcan-light**: 灯光控制模块
   - 功能：根据情绪状态显示不同的灯光效果
   - 效果：彩虹、蓝色闪电、紫色追逐、呼吸灯等多种灯光模式
   - 硬件：WS2812灯带(GPIO18)，支持200个独立控制的LED灯珠

3. **espcan-sound**: 声音控制模块
   - 功能：播放不同情绪状态对应的音效
   - 音效：打雷、小雨点、木鱼敲击、开心和随机等多种音效
   - 控制：低电平触发，每个音效有独立的防重复触发保护

4. **espcan-motor**: 电机控制模块
   - 功能：控制电机速度和模式
   - 特点：支持固定速度和渐变速度两种模式
   - 控制：PWM控制(GPIO19)和继电器控制(GPIO23)

5. **espcan-fogger**: 雾化器控制模块
   - 功能：根据情绪状态控制雾化效果
   - 控制：继电器控制(GPIO26)，开启/关闭雾化器

6. **td-tester**: 测试模拟器
   - 功能：用于模拟木鱼敲击和情绪状态控制
   - 界面：图形化界面，提供各种情绪状态的触发按钮

## 情绪状态映射

系统支持以下情绪状态：

1. **开心(EMOTION_HAPPY=1)**:
   - 灯光: 彩虹灯效
   - 声音: 开心音效(GPIO18)
   - 电机: 中速渐变
   
2. **伤心(EMOTION_SAD=2)**:
   - 灯光: 紫色追逐
   - 声音: 小雨点音效(GPIO22)
   - 雾化器: 开启
   
3. **惊讶(EMOTION_SURPRISE=3)**:
   - 灯光: 蓝色闪电
   - 声音: 打雷闪电音效(GPIO23)
   - 电机: 高速
   
4. **随机(EMOTION_RANDOM=4)**:
   - 灯光: 呼吸灯效果
   - 声音: 随机音效(GPIO17)
   - 电机: 渐变速度
   
5. **木鱼敲击(WOODFISH_HIT=5)**:
   - 声音: 木鱼敲击音效(GPIO19)

## 通信协议

所有模块通过CAN总线通信，使用以下消息ID：

| 消息ID | 名称 | 功能 | 数据格式 |
|--------|------|------|----------|
| 0x123 | WOODEN_FISH_HIT_ID | 木鱼敲击事件 | [1]=敲击事件(1) |
| 0x456 | LED_CMD_ID | LED控制命令 | [1]=状态(0/1) |
| 0x789 | EMOTION_CMD_ID | 情绪状态命令 | [1]=情绪状态(1-4) |
| 0xABC | RANDOM_CMD_ID | 随机效果命令 | [1]=状态,[2]=参数1,[3]=参数2 |
| 0x301 | MOTOR_CMD_ID | 电机控制命令 | [1]=PWM(0-255),[2]=状态(0/1),[3]=渐变模式(0/1) |
| 0x321 | FOGGER_CMD_ID | 雾化器控制命令 | [1]=状态(0/1) |

## 系统功能特点

1. **分布式控制**：每个功能模块独立运行，通过CAN总线通信
2. **多样化情绪表达**：通过声光电组合表达不同情绪
3. **木鱼互动界面**：通过敲击实体木鱼触发系统反馈
4. **智能防抖动**：木鱼敲击检测采用双传感器确认和时间消抖
5. **声音播放保护**：防止快速连续触发导致声音设备异常
6. **灯光渐变效果**：多种灯光动画效果，包括彩虹、闪电、追逐等
7. **电机速度控制**：支持固定速度和渐变速度模式
8. **测试模拟界面**：图形化界面用于开发和调试

## 开发环境

- ESP32开发板
- ESP-IDF框架
- PlatformIO开发环境

## 硬件配置

- CAN总线通信使用TJA1050或SN65HVD230等CAN收发器
- 每个模块使用独立的ESP32连接相应的外设
- 木鱼主控使用振动传感器和声音传感器检测敲击
- 灯光模块使用WS2812灯带
- 声音模块通过GPIO控制外部音频设备
- 电机模块使用PWM控制电机速度
- 雾化器模块通过继电器控制雾化设备

## 使用方法

1. 使用PlatformIO编译并上传各个模块代码到对应ESP32开发板
2. 正确连接各模块的硬件设备
3. 接通电源，各模块会自动初始化并通过CAN总线建立通信
4. 敲击木鱼或使用td-tester模拟器触发不同情绪状态
5. 系统会根据情绪状态展示不同的声光电效果

## 开发者

- Peter Pan's Tech Land
- 项目地址: [GitHub](https://github.com/peterpanstechland/espcan-test)

## 许可证

MIT License 